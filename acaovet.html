<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√ß√£o VET - Mongagu√°</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #1a5276; --secondary: #27ae60; --accent: #f39c12; --bg: #eef2f3; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .navbar { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .btn-gestor { background: var(--accent); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-logout { background: var(--danger) !important; }
        .container { max-width: 950px; margin: 20px auto; padding: 0 15px; }
        .search-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #searchInput { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .grid-pacientes { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-left: 6px solid var(--secondary); cursor: pointer; transition: 0.2s; position: relative; }
        .status-badge { font-size: 0.7em; padding: 4px 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; float: right; }
        .st-tratamento { background: #d6eaf8; color: #2e86c1; }
        .st-recuperado { background: #d4f8e2; color: #1e8449; }
        .st-urgencia { background: #fadbd8; color: #c0392b; }
        .st-cirurgia { background: #fef9e7; color: #f39c12; }
        .modal-ficha { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; }
        .tabs { display: flex; gap: 5px; max-width: 950px; margin: 15px auto; overflow-x: auto; padding: 0 15px; }
        .tab-btn { padding: 12px 20px; border: none; background: #eee; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .form-section { display: none; max-width: 950px; margin: auto; padding: 20px; }
        .form-section.active { display: block; }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full { grid-column: span 2; }
        label { font-size: 0.85em; font-weight: bold; color: #444; margin-bottom: 5px; display: block; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .timeline { background: #fdfdfd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #eee; }
        .entry { background: white; padding: 12px; border-bottom: 1px solid #eee; margin-bottom: 8px; border-left: 4px solid var(--secondary); font-size: 0.9em; }
    </style>
</head>
<body>

<nav class="navbar">
    <h1>A√ß√£o <span>VET</span></h1>
    <button class="btn-gestor" id="btnAcesso" onclick="gerenciarLogin()">üîì Acesso Gestor</button>
</nav>

<div class="container">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Pesquisar..." onkeyup="filtrarPacientes()">
    </div>
    <div class="grid-pacientes" id="listaPacientes">Sincronizando com a nuvem...</div>
    <div style="text-align: center; margin-top: 20px;">
        <button class="btn-gestor" id="btnNovo" style="display:none; padding: 15px 40px;" onclick="abrirFicha(null)">+ Novo Prontu√°rio</button>
    </div>
</div>

<div id="modalFicha" class="modal-ficha">
    <div class="modal-header" style="max-width:950px; margin:auto; display:flex; justify-content:space-between; padding:20px; align-items:center;">
        <h2>Prontu√°rio Digital</h2>
        <button onclick="fecharFicha()" style="padding:10px; cursor:pointer; background:#eee; border:none; border-radius:5px;">‚úñ Fechar</button>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="mudarAba(event, 'aba_tutor')">1. Tutor</button>
        <button class="tab-btn" onclick="mudarAba(event, 'aba_animal')">2. Animal</button>
        <button class="tab-btn" onclick="mudarAba(event, 'aba_terapeutica')">3. Terap√™utica</button>
        <button class="tab-btn" onclick="mudarAba(event, 'aba_evolucao')">4. Evolu√ß√£o</button>
    </div>

    <div id="aba_tutor" class="form-section active">
        <div class="grid-form">
            <div class="full"><label>Tutor</label><input type="text" id="f_tutor"></div>
            <div><label>CPF</label><input type="text" id="f_cpf"></div>
            <div><label>Renda</label><input type="number" id="f_renda"></div>
            <div class="full"><label>Local</label><input type="text" id="f_local" value="Mongagu√°, SP"></div>
        </div>
    </div>

    <div id="aba_animal" class="form-section">
        <div class="grid-form">
            <div class="full"><label>Status</label>
                <select id="f_status">
                    <option value="st-tratamento">Em Tratamento</option>
                    <option value="st-recuperado">Recuperado</option>
                    <option value="st-urgencia">Urg√™ncia</option>
                    <option value="st-cirurgia">Cirurgia</option>
                </select>
            </div>
            <div><label>Animal</label><input type="text" id="f_animal"></div>
            <div><label>Esp√©cie</label><input type="text" id="f_esp"></div>
            <div><label>Ra√ßa</label><input type="text" id="f_raca"></div>
            <div><label>Idade</label><input type="text" id="f_idade"></div>
        </div>
    </div>

    <div id="aba_terapeutica" class="form-section">
        <div class="grid-form" style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <div class="full"><label>Diagn√≥stico</label><input type="text" id="f_diag"></div>
            <div><label>Vet.</label><input type="text" id="m_vet"></div>
            <div><label>CRMV</label><input type="text" id="m_crmv"></div>
            <div><label>Medica√ß√£o</label><input type="text" id="m_desc"></div>
            <div><label>Valor (R$)</label><input type="number" id="m_val" step="0.01"></div>
            <div class="full"><button type="button" class="btn-gestor" id="btnAddMed" onclick="addHist('med')">+ Registrar na Ficha</button></div>
        </div>
        <div class="timeline" id="lista_med"></div>
    </div>

    <div id="aba_evolucao" class="form-section">
        <div class="grid-form" style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <div><label>Data</label><input type="date" id="e_data"></div>
            <div><label>Vet.</label><input type="text" id="e_vet"></div>
            <div><label>CRMV</label><input type="text" id="e_crmv"></div>
            <div class="full"><label>Relato</label><textarea id="e_relato"></textarea></div>
            <div class="full"><button type="button" class="btn-gestor" id="btnAddEvo" onclick="addHist('evo')">+ Adicionar Evolu√ß√£o</button></div>
        </div>
        <div class="timeline" id="lista_evo"></div>
    </div>

    <div class="footer-ficha" style="max-width:950px; margin:auto; padding:20px; text-align:right;">
        <button class="btn-gestor" id="btnSalvar" style="background:var(--secondary); display:none;" onclick="salvarFirebase()">üíæ Salvar na Nuvem</button>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu26gkLS-a3gIuVeItwWBg92Cm7l2cMHI",
      authDomain: "acao-vet.firebaseapp.com",
      projectId: "acao-vet",
      storageBucket: "acao-vet.firebasestorage.app",
      messagingSenderId: "1041719589005",
      appId: "1:1041719589005:web:26ac4b6358f21cd2c10ac4",
      measurementId: "G-C4989LM0LV"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let modoGestor = false;
    let fichaAtiva = null;

    function monitorarDados() {
        db.collection("pacientes").onSnapshot((snapshot) => {
            const pacientes = [];
            snapshot.forEach(doc => pacientes.push({ id_doc: doc.id, ...doc.data() }));
            renderizarLista(pacientes);
        });
    }

    function renderizarLista(dados) {
        const nomesStatus = { 'st-tratamento': 'Em Tratamento', 'st-recuperado': 'Recuperado', 'st-urgencia': 'Urg√™ncia', 'st-cirurgia': 'Cirurgia' };
        document.getElementById('listaPacientes').innerHTML = dados.map(p => `
            <div class="card" onclick="abrirFicha('${p.id_doc}')">
                <span class="status-badge ${p.status}">${nomesStatus[p.status]}</span>
                <h3>üêæ ${p.animal || 'Sem nome'}</h3>
                <p>Tutor: ${p.tutor || 'N√£o informado'}</p>
            </div>
        `).join('');
    }

    function gerenciarLogin() {
        if(!modoGestor) {
            if(prompt("Senha:") === "1234") {
                modoGestor = true;
                document.getElementById('btnAcesso').innerText = "üîí Sair do Gestor";
                document.getElementById('btnAcesso').classList.add('btn-logout');
                document.getElementById('btnNovo').style.display = 'inline-block';
                document.getElementById('btnSalvar').style.display = 'inline-block';
                if(fichaAtiva) statusCampos(false);
            }
        } else {
            location.reload();
        }
    }

    async function abrirFicha(id) {
        document.getElementById('modalFicha').style.display = 'block';
        if(id) {
            const doc = await db.collection("pacientes").doc(id).get();
            fichaAtiva = { id_doc: doc.id, ...doc.data() };
            carregarCampos(fichaAtiva);
        } else {
            fichaAtiva = { med: [], evo: [], status: 'st-tratamento' };
            limparCampos();
        }
        statusCampos(!modoGestor);
    }

    function carregarCampos(p) {
        document.getElementById('f_tutor').value = p.tutor || "";
        document.getElementById('f_animal').value = p.animal || "";
        document.getElementById('f_status').value = p.status || "st-tratamento";
        document.getElementById('f_diag').value = p.diag || "";
        document.getElementById('f_cpf').value = p.cpf || "";
        document.getElementById('f_renda').value = p.renda || "";
        document.getElementById('f_esp').value = p.esp || "";
        document.getElementById('f_raca').value = p.raca || "";
        document.getElementById('f_idade').value = p.idade || "";
        renderHist();
    }

    function addHist(tipo) {
        if(tipo === 'med') {
            const entry = `${document.getElementById('m_desc').value} - R$ ${document.getElementById('m_val').value} (${document.getElementById('m_vet').value})`;
            fichaAtiva.med.push(entry);
        } else {
            const entry = `<b>${document.getElementById('e_data').value}</b>: ${document.getElementById('e_relato').value}`;
            fichaAtiva.evo.push(entry);
        }
        renderHist();
    }

    function renderHist() {
        document.getElementById('lista_med').innerHTML = fichaAtiva.med.map(m => `<div class="entry">${m}</div>`).join('');
        document.getElementById('lista_evo').innerHTML = fichaAtiva.evo.map(e => `<div class="entry">${e}</div>`).join('');
    }

    async function salvarFirebase() {
        const dados = {
            tutor: document.getElementById('f_tutor').value,
            animal: document.getElementById('f_animal').value,
            status: document.getElementById('f_status').value,
            diag: document.getElementById('f_diag').value,
            cpf: document.getElementById('f_cpf').value,
            renda: document.getElementById('f_renda').value,
            esp: document.getElementById('f_esp').value,
            raca: document.getElementById('f_raca').value,
            idade: document.getElementById('f_idade').value,
            med: fichaAtiva.med,
            evo: fichaAtiva.evo
        };
        try {
            if(fichaAtiva.id_doc) await db.collection("pacientes").doc(fichaAtiva.id_doc).update(dados);
            else await db.collection("pacientes").add(dados);
            alert("Sincronizado!");
            fecharFicha();
        } catch (e) {
            alert("Erro ao salvar! Verifique as permiss√µes do Firebase.");
        }
    }

    function mudarAba(evt, id) {
        const sect = document.getElementsByClassName("form-section");
        for (let s of sect) s.classList.remove("active");
        const btns = document.getElementsByClassName("tab-btn");
        for (let b of btns) b.classList.remove("active");
        document.getElementById(id).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    function fecharFicha() { document.getElementById('modalFicha').style.display = 'none'; }
    function statusCampos(bloq) { document.querySelectorAll('input, textarea, select, button[id^="btnAdd"]').forEach(i => i.disabled = bloq); }
    function limparCampos() { document.querySelectorAll('input, textarea').forEach(i => i.value = ""); renderHist(); }
    
    function filtrarPacientes() {
        const termo = document.getElementById('searchInput').value.toLowerCase();
        db.collection("pacientes").get().then(snap => {
            const filtrados = [];
            snap.forEach(doc => {
                const p = doc.data();
                if(p.tutor?.toLowerCase().includes(termo) || p.animal?.toLowerCase().includes(termo)) filtrados.push({ id_doc: doc.id, ...p });
            });
            renderizarLista(filtrados);
        });
    }

    monitorarDados();
</script>
</body>
</html>